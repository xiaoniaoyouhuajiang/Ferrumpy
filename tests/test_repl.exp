#!/usr/bin/expect -f
#
# FerrumPy REPL Integration Test - Simplified
#
# Tests basic REPL functionality

set timeout 300
set project_root [lindex $argv 0]

# Disable terminal formatting to avoid ANSI escape sequence issues
set env(TERM) dumb

# Start LLDB
spawn lldb $project_root/tests/rust_sample/target/debug/rust_sample

# Load ferrumpy
expect "(lldb)"
send "command script import $project_root/python/ferrumpy\r"

# Set breakpoint
expect "loaded"
send "b main.rs:94\r"

# Run
expect "Breakpoint"
send "run\r"

# Wait for breakpoint hit and lldb prompt
expect "stop reason = breakpoint"
expect "(lldb)"

# Start REPL
send "ferrumpy repl\r"

# Wait for REPL prompt (>> ) - this may take time for compilation
expect {
    ">>" {
        puts "\n✓ REPL initialized and prompt ready"
    }
    timeout {
        puts "\n✗ Timeout waiting for REPL prompt"
        exit 1
    }
}

# Test 1: Basic expression evaluation
send "let x = 42;\r"
expect ">>"

send "x + 1\r"
expect {
    "43" {
        puts "✓ Basic expression evaluation works"
    }
    timeout {
        puts "\n✗ Basic expression evaluation failed"
        exit 1
    }
}

# Test 2: String manipulation
expect ">>"
send "\"hello\".to_uppercase()\r"
expect {
    "HELLO" {
        puts "✓ String method works"
    }
    timeout {
        puts "\n⚠ String method timeout (may be acceptable)"
    }
}

# Exit REPL
expect ">>"
send ":q\r"

expect {
    -re "(REPL session ended|lldb)" {
        puts "✓ REPL exit successful"
    }
    timeout {
        puts "\n⚠ Timeout on REPL exit (may be acceptable)"
    }
}

# Clean up
expect "(lldb)"
send "kill\r"
expect "(lldb)"
send "quit\r"

puts "\n=== REPL Integration Test PASSED ==="
exit 0
