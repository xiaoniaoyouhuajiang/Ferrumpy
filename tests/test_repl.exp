#!/usr/bin/expect -f
#
# FerrumPy REPL Integration Test - Simplified
#
# Tests basic REPL functionality

set timeout 300
set project_root [lindex $argv 0]

# Disable terminal formatting to avoid ANSI escape sequence issues
set env(TERM) dumb

# Start LLDB
spawn lldb $project_root/tests/rust_sample/target/debug/rust_sample

# Load ferrumpy
expect "(lldb)"
send "command script import $project_root/python/ferrumpy\r"

# Set breakpoint
expect "loaded"
send "b main.rs:94\r"

# Run
expect "Breakpoint"
send "run\r"

# Wait for breakpoint hit and lldb prompt
expect "stop reason = breakpoint"
expect "(lldb)"

# Start REPL
send "ferrumpy repl\r"

# Wait for REPL prompt (>> ) - this may take time for compilation
expect {
    ">>" {
        puts "\n✓ REPL initialized and prompt ready"
    }
    timeout {
        puts "\n✗ Timeout waiting for REPL prompt"
        exit 1
    }
}

# Test 1: Basic expression evaluation
send "let x = 42;\r"
expect ">>"

send "x + 1\r"
expect {
    "43" {
        puts "✓ Basic expression evaluation works"
    }
    timeout {
        puts "\n✗ Basic expression evaluation failed"
        exit 1
    }
}

# Test 2: String manipulation
expect ">>"
send "\"hello\".to_uppercase()\r"
expect {
    "HELLO" {
        puts "✓ String method works"
    }
    timeout {
        puts "\n⚠ String method timeout (may be acceptable)"
    }
}

# ========================================
# Test 3: Snapshot Variable Access Tests
# ========================================
# These test that captured variables from the debugged process are accessible

# Test 3a: Access simple_string (String type)
expect ">>"
send "simple_string.clone()\r"
expect {
    "Hello" {
        puts "✓ Snapshot variable 'simple_string' accessible"
    }
    "error" {
        puts "\n✗ FAILED: Cannot access snapshot variable 'simple_string'"
        exit 1
    }
    timeout {
        puts "\n✗ Timeout accessing 'simple_string'"
        exit 1
    }
}

# Test 3b: Access numbers (Vec<i32>)
expect ">>"
send "numbers.len()\r"
expect {
    "5" {
        puts "✓ Snapshot variable 'numbers' accessible (len=5)"
    }
    "error" {
        puts "\n✗ FAILED: Cannot access snapshot variable 'numbers'"
        exit 1
    }
    timeout {
        puts "\n✗ Timeout accessing 'numbers'"
        exit 1
    }
}

# Test 3c: Access ok_result (Result<i32, String> or serde_json::Value)
expect ">>"
send "ok_result\r"
expect {
    -re "Ok|Err|Object|Number|String|Null|Array" {
        puts "✓ Snapshot variable 'ok_result' accessible"
    }
    "cannot find value" {
        puts "\n✗ FAILED: Cannot access snapshot variable 'ok_result'"
        exit 1
    }
    timeout {
        puts "\n✗ Timeout accessing 'ok_result'"
        exit 1
    }
}

# Test 3d: Access map (HashMap<String, i32> or serde_json::Value)
expect ">>"
send "map\r"
expect {
    -re "Object|Number|String|Null|Array" {
        puts "✓ Snapshot variable 'map' accessible"
    }
    "cannot find value" {
        puts "\n✗ FAILED: Cannot access snapshot variable 'map'"
        exit 1
    }
    timeout {
        puts "\n✗ Timeout accessing 'map'"
        exit 1
    }
}

# Exit REPL
expect ">>"
send ":q\r"

expect {
    -re "(REPL session ended|lldb)" {
        puts "✓ REPL exit successful"
    }
    timeout {
        puts "\n⚠ Timeout on REPL exit (may be acceptable)"
    }
}

# Clean up
expect "(lldb)"
send "kill\r"
expect "(lldb)"
send "quit\r"

puts "\n=== REPL Integration Test PASSED ==="
exit 0
