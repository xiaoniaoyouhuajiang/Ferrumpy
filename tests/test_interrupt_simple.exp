#!/usr/bin/expect -f
set timeout 30

# Force simple mode
set env(FERRUMPY_SIMPLE_MODE) 1
set env(TERM) dumb

spawn lldb tests/rust_sample/target/debug/rust_sample

expect "(lldb)"
send "command script import python/ferrumpy\r"
expect "loaded"

expect "(lldb)"
send "b main.rs:94\r"
expect "Breakpoint"

expect "(lldb)"
send "run\r"
expect "stop reason"

expect "(lldb)"
send "ferrumpy repl\r"
expect {
    "REPL ready" {
        puts "\n=== REPL started ==="
    }
    timeout {
        puts "\n=== ERROR: REPL did not start ==="
        exit 1
    }
}

expect ">>"
send "tuple\r"
expect {
    "first" {
        puts "\n=== ✓ Tuple accessible before interrupt ==="
    }
    "error" {
        puts "\n=== ✗ Tuple NOT accessible before interrupt ==="
        exit 1
    }
}

expect ">>"
send "loop \{\}\r"
sleep 2

send "\x03"

# Capture all DEBUG output
expect {
    -re "\\[DEBUG\\].*" {
        puts "\n=== DEBUG: $expect_out(0,string) ==="
        exp_continue
    }
    ">>" {
        puts "\n=== Got prompt after interrupt ==="
    }
    timeout {
        puts "\n=== Timeout waiting for prompt ==="
        exit 1
    }
}

send "tuple\r"
expect {
    "first" {
        puts "\n=== ✓ SUCCESS: Tuple still accessible! ==="
        set result "PASS"
    }
    "error" {
        puts "\n=== ✗ FAIL: Tuple lost ==="
        set result "FAIL"
    }
    timeout {
        puts "\n=== Timeout ==="
        set result "FAIL"
    }
}

send ":q\r"
expect "(lldb)"
send "quit\r"

if {$result == "PASS"} {
    exit 0
} else {
    exit 1
}
